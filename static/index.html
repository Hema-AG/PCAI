<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P&C AI Video Generator</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #f9c74f;
            --danger: #f94144;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background-color: #f5f7fb;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        h2 {
            color: var(--secondary);
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        textarea {
            min-height: 200px;
            resize: vertical;
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
            display: inline-block;
            width: 100%;
            margin-top: 10px;
        }
        
        button:hover {
            background: var(--secondary);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .video-player-container {
            width: 100%;
            margin-top: 20px;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .progress-section {
            margin-top: 20px;
        }
        
        .progress-bar-container {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.4s ease-in-out;
        }
        
        .status-text {
            font-style: italic;
            color: #6c757d;
        }
        
        .download-link {
            display: none; /* Hidden by default */
            margin-top: 15px;
            padding: 10px 15px;
            background: var(--success);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 600;
            text-align: center;
        }
        
        .upload-area {
            border: 2px dashed #ddd;
            padding: 40px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
        }
        
        .upload-area:hover {
            border-color: var(--primary);
        }
        
        .upload-area.dragover {
            border-color: var(--success);
            background: rgba(76, 201, 240, 0.1);
        }

        .error-message {
            color: var(--danger);
            background: rgba(249, 65, 68, 0.1);
            border: 1px solid var(--danger);
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            display: none; /* Hidden by default */
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>P&C AI Video Generator</h1>
            <p>Transform your PowerPoint presentations into narrated videos</p>
        </header>

        <div id="upload-section">
            <h2>Step 1: Upload Your Presentation</h2>
            <div class="upload-area" id="pptx-upload-area">
                <p>Drag & drop your PowerPoint file here or click to browse</p>
                <input type="file" id="pptx-file-input" accept=".pptx" class="hidden">
            </div>
            
            <div class="form-group">
                <label for="pptx-language">Narration Language:</label>
                <select id="pptx-language">
                    <option value="en">English</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="it">Italian</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="pptx-speed">Voice Speed:</label>
                <select id="pptx-speed">
                    <option value="normal">Normal</option>
                    <option value="slow">Slow</option>
                </select>
            </div>
            
            <button id="extract-transcript-btn" disabled>Extract Transcript</button>
        </div>

        <div id="edit-transcript-section" class="hidden">
            <h2>Step 2: Edit the Transcript</h2>
            <div class="form-group">
                <label for="transcript-editor">You can edit the narration script for each slide below before generating the video.</label>
                <textarea id="transcript-editor"></textarea>
            </div>
            <button id="generate-video-btn">Confirm Transcript & Generate Video</button>
        </div>

        <div id="processing-section" class="hidden">
             <h2>Generating Your Video</h2>
             <p>This may take a few minutes. Please don't close this window.</p>
             <div class="progress-section">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="status-text" id="progress-text">Initializing...</div>
            </div>
            <div id="error-message" class="error-message"></div>
        </div>

        <div id="video-result-section" class="video-player-container hidden">
             <h2>Your Video is Ready!</h2>
            <video controls id="video-player" width="100%"></video>
            <a href="#" class="download-link" id="download-btn" download="presentation.mp4">Download MP4 Video</a>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const uploadSection = document.getElementById('upload-section');
        const editTranscriptSection = document.getElementById('edit-transcript-section');
        const processingSection = document.getElementById('processing-section');
        const videoResultSection = document.getElementById('video-result-section');
        
        const uploadArea = document.getElementById('pptx-upload-area');
        const fileInput = document.getElementById('pptx-file-input');
        const extractBtn = document.getElementById('extract-transcript-btn');
        const generateBtn = document.getElementById('generate-video-btn');
        const transcriptEditor = document.getElementById('transcript-editor');
        
        // --- State Variables ---
        let selectedFile = null;
        let currentJobId = null;
        let progressInterval = null;

        // --- File Upload Handling (Drag & Drop, Click) ---
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                handleFileSelection(e.dataTransfer.files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFileSelection(e.target.files[0]);
            }
        });

        function handleFileSelection(file) {
            if (!file.name.toLowerCase().endsWith('.pptx')) {
                alert('Please select a valid PowerPoint (.pptx) file.');
                return;
            }
            selectedFile = file;
            uploadArea.innerHTML = `<p><strong>Selected file:</strong> ${file.name}</p>`;
            extractBtn.disabled = false;
        }

        // --- Step 1: Extract Transcript ---
        extractBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            // Show loading state
            extractBtn.disabled = true;
            extractBtn.textContent = 'Extracting...';

            try {
                // --- MOCK API CALL ---
                // In a real application, you would make an API call here to your backend
                // to extract the text from the PPTX file.
                // const formData = new FormData();
                // formData.append('file', selectedFile);
                // const response = await fetch('/api/pptx/extract-text', { method: 'POST', body: formData });
                // const data = await response.json();
                // const extractedText = data.transcript;

                // For demonstration, we'll use a timeout and dummy data.
                await new Promise(resolve => setTimeout(resolve, 1500));
                const dummyTranscript = "Slide 1: Welcome to the P&C AI Video Generator.\n\n" +
                                        "Slide 2: This is a demonstration of how to convert a PowerPoint presentation into a narrated video.\n\n" +
                                        "Slide 3: You can edit this text to customize the final narration.\n\n" +
                                        "Slide 4: Thank you for trying our tool.";

                transcriptEditor.value = dummyTranscript;

                // Transition to the next step
                uploadSection.classList.add('hidden');
                editTranscriptSection.classList.remove('hidden');

            } catch (error) {
                console.error('Error extracting transcript:', error);
                alert('Failed to extract transcript from the presentation.');
                extractBtn.disabled = false;
                extractBtn.textContent = 'Extract Transcript';
            }
        });

        // --- Step 2: Generate Video (Starts the Polling Job) ---
        generateBtn.addEventListener('click', () => {
            if (!selectedFile) return;

            const finalTranscript = transcriptEditor.value;
            const language = document.getElementById('pptx-language').value;
            const speed = document.getElementById('pptx-speed').value;

            // Hide edit section and show processing section
            editTranscriptSection.classList.add('hidden');
            processingSection.classList.remove('hidden');
            
            startVideoGenerationJob(selectedFile, finalTranscript, language, speed);
        });

        async function startVideoGenerationJob(file, transcript, language, speed) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('transcript', transcript);
            formData.append('language', language);
            formData.append('voice_speed', speed);

            showProgress('Uploading and initializing...', 5);
            
            try {
                // This is the main API call that starts the long-running job
                const response = await fetch('/api/tts/process-pptx', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.status === 202) { // 202 Accepted: Job started successfully
                    const result = await response.json();
                    currentJobId = result.job_id;
                    startProgressPolling(); // Begin polling for updates
                } else {
                    const error = await response.json();
                    showError('Failed to start process: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                showError('Upload failed: ' + error.message);
            }
        }

        // --- Progress Polling and UI Updates ---
        function startProgressPolling() {
            if (progressInterval) clearInterval(progressInterval); // Clear existing interval

            progressInterval = setInterval(async () => {
                if (!currentJobId) return;
                
                try {
                    const response = await fetch(`/api/tts/job-status/${currentJobId}`);
                    if (!response.ok) throw new Error(`Server responded with status ${response.status}`);
                    const status = await response.json();
                    
                    if (status.status === 'completed') {
                        clearInterval(progressInterval);
                        showProgress('Processing complete!', 100);
                        displayFinalVideo(status.download_url);
                    } else if (status.status === 'error') {
                        clearInterval(progressInterval);
                        showError('Processing failed: ' + status.message);
                    } else {
                        // Update progress bar and text
                        showProgress(status.message, status.progress);
                    }
                } catch (error) {
                    console.error('Error polling status:', error);
                    showError('Could not retrieve job status. Please check again later.');
                    clearInterval(progressInterval);
                }
            }, 2500); // Poll every 2.5 seconds
        }

        function showProgress(message, percent) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            percent = Math.min(Math.max(percent, 0), 100); // Clamp percentage between 0 and 100
            
            if (progressBar) {
                progressBar.style.width = `${percent}%`;
                progressBar.setAttribute('aria-valuenow', percent);
            }
            if (progressText) {
                progressText.textContent = message;
            }
        }

        function displayFinalVideo(videoUrl) {
            processingSection.classList.add('hidden');
            videoResultSection.classList.remove('hidden');

            const videoPlayer = document.getElementById('video-player');
            const downloadBtn = document.getElementById('download-btn');
            
            videoPlayer.src = videoUrl;
            downloadBtn.href = videoUrl;
            downloadBtn.style.display = 'inline-block'; // Show the download button
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
            // Also hide the progress bar to indicate a stop
             const progressText = document.getElementById('progress-text');
             progressText.textContent = "An error occurred.";
        }
    </script>
</body>
</html>